{% extends "templates/layout.html" %}

{% block title %}
{{ _("Student Report Card") }}
{% endblock %}

{% block headnav_link %}
    {% include "templates/includes/headnav/edu_headnav3.html" %}
{% endblock %}

{% block content %}
<style>

    @media screen {
    .print-format-gutter {
      background-color: #ddd;
      padding: 15px 0px;
    }
    .print-format {
      background-color: white;
      box-shadow: 0px 0px 9px rgba(0,0,0,0.5);
      max-width: 8.3in;
      min-height: 11.69in;
      padding: 0.75in;
      margin: auto;
    }

    .print-format.landscape {
      max-width: 11.69in;
      padding: 0.2in;
    }

    .page-break {
      padding: 30px 0px;
      border-bottom: 1px dashed #888;
    }

    .page-break:first-child {
      padding-top: 0px;
    }

    .page-break:last-child {
      border-bottom: 0px;
    }

    /* mozilla hack for images in table */
    body:last-child .print-format td img {
      width: 100% !important;
    }

    @media(max-width: 767px) {
      .print-format {
        padding: 0.2in;
      }
    }
  }

  @media print {
    .print-format p {
      margin-left: 1px;
      margin-right: 1px;
    }
  }

  .data-field {
    margin-top: 5px;
    margin-bottom: 5px;
  }

  .data-field .value {
    word-wrap: break-word;
  }

  .important .value {
    font-size: 120%;
    font-weight: bold;
  }

  .important label {
    line-height: 1.8;
    margin: 0px;
  }

  .table {
    margin: 10px 0px;
  }

  .square-image {
    width: 100%;
    height: 0;
    padding: 50% 0;
    background-size: contain;
    /*background-size: cover;*/
    background-repeat: no-repeat !important;
    background-position: center center;
    border-radius: 4px;
  }

  .print-item-image {
    object-fit: contain;
  }

  .pdf-variables,
  .pdf-variable,
  .visible-pdf {
    display: none !important;
  }

  .print-format {
    font-size: 7pt;
    font-family: "Helvetica Neue", Helvetica, Arial, "Open Sans", sans-serif;
    -webkit-print-color-adjust:exact;
  }

  .page-break {
    page-break-after: always;
  }

  table.no-border, table.no-border td {
    border: 0px;
  }

  .print-format label {
    /* wkhtmltopdf breaks label into multiple lines when it is inline-block */
    display: block;
  }

  .print-format img {
    max-width: 100%;
  }

  .print-format table td > .primary:first-child {
    font-weight: bold;
  }

  .print-format td, .print-format th {
    vertical-align: middle !important;
    padding: 3px !important;
  }

  .print-format p {
    margin: 3px 0px 3px;
  }

  table td div {

    /* needed to avoid partial cutting of text between page break in wkhtmltopdf */
    page-break-inside: avoid !important;

  }

  /* hack for webkit specific browser */
  @media (-webkit-min-device-pixel-ratio:0) {
    thead, tfoot { display: table-row-group; }
  }


  .text-primary-head {
      color: #043f80; /* or any warning color you prefer */
  }

/* Break slot column */
.break-slot {
  background-color: #f4f4f4;
  font-style: italic;
  color: #555;
}

/* Break cell content */
.break-label {
  font-size: 11px;
  font-weight: bold;
  color: #888;
}

/* Example class schedule colors */
.math { background-color: #e1f0ff; }
.english { background-color: #fff5e1; }
.science { background-color: #e1ffe4; }
.cancelled { background-color: #ffe1e1; }


</style>

<main class="grow content pt-5 {% if 'Student' in user_roles and not 'Academics User' in user_roles %}bg-gray-100{% endif %}" id="content" role="content">
 <!-- begin: container -->
 <div class="container-fixed" id="content_container">
 </div>
 <!-- end: container -->
  {% if "Academics User" in user_roles or "Parent" in user_roles %}
  {% include "templates/includes/student_header.html" %}

  {% include "templates/includes/student_nav.html" %}
  {% endif %}
 <!-- begin: container -->
 <div class="container-fixed">
  <div class="flex flex-wrap items-center lg:items-end justify-between gap-5 pb-7.5">
   <div class="flex flex-col justify-center gap-2">
    {% if sections %}   
    <h1 class="text-xl font-semibold leading-none text-primary">
     Class Timetable
    </h1>
    <div class="flex items-center flex-wrap gap-1.5 font-medium">
     <span class="text-md text-gray-600">
       {{ sections.program_section or ""}} 
     </span>
    </div>
    {% endif %}
   </div>
  </div>
 </div>
 <!-- end: container -->

{% set sections = sections or {} %}
{% set timetable_slots = timetable_slots or [] %}
{% set days = days_order or [] %}
{% set timetable_map = timetable_map or {} %}

{% if timetable_slots and days %}
  <div class="container-fixed" id="content_container">
    <div class="grid gap-5 lg:gap-7.5">
      <div class="card">
        <div class="card-body lg:py-7.5">

          <p class="text-center">
            <b class="text-center" style="font-size: 12pt">
              {{ sections.program_section if sections.program_section is defined else (sections if sections is string else '') }} Timetable
            </b>
          </p>
          <div class="grid">
           <div class="card min-w-full">
            <div class="card-table scrollable-x-auto">
             <table class="table align-middle text-center text-gray-700 font-medium text-xs">
              <thead>
               <tr>
                <th class="min-w-[125px]">
                 Start Time
                </th>
                <th class="min-w-[125px]">
                 End Time
                </th>
                {% for day in days %}
                <th class="min-w-[200px]">
                 {{ day }}
                </th>
                {% endfor %}
               </tr>
              </thead>
              <tbody>
               <!-- {# iterate through timetable slots in order; for each slot render a row #} -->
               {% for slot in timetable_slots %}
                <tr>
                  <td class="bg-success-light text-primary-head">{{ slot.start_time or slot.get("start_time") or "" }}</td>
                  <td class="bg-danger-light text-primary-head">{{ slot.end_time or slot.get("end_time") or "" }}</td>

                  <!-- {# if this slot is a break, render a single cell that spans all day columns #} -->
                  {% if slot.is_break %}
                    <td class="bg-info-light" style="text-align: center; font-style: italic; color: #374151;" colspan="{{ days|length }}">
                      <div style="font-weight:700;">
                        {{ slot.label or slot.period_label or "Break" }}
                      </div>
                      {% if slot.duration %}
                        <div style="font-size:11px;color:#6b7280;">{{ slot.duration }} min</div>
                      {% endif %}
                    </td>
                  {% else %}
                    <!-- {# Normal slot: render one cell per day using timetable_map[day][loop_index] #} -->
                    {% set idx = loop.index0 %}
                    {% for day in days %}
                      {% set day_row = timetable_map.get(day, []) %}
                      {% set cell = None %}
                      {% if day_row and day_row|length > idx %}
                        {% set cell = day_row[idx] %}
                      {% endif %}

                      {% if cell %}
                        {% set bg = cell.class_schedule_color if cell.class_schedule_color else '' %}
                        <td class="bg-gray-100">
                          <div class="card">
                            <div class="card-body">
                         <span class="badge badge-pill badge-outline badge-primary">
                          <!-- {# Course name (fall back to course field) #} -->
                          <div style="font-weight: 700; font-size: 11px;{% if bg %} color: {{ bg }};{% endif %}">
                            {% if cell.course_name %}{{ cell.course_name }}{% elif cell.course %}{{ cell.course }}{% else %}{{ cell.get('name') or 'Scheduled' }}{% endif %}
                          </div>
                         </span>

                          <!-- {# Instructor if available #} -->
                          {% if cell.instructor_name %}
                            <div style="font-size: 10px; color: #6b021f; margin-top: .25rem;">{{ cell.instructor_name }}</div>
                          {% elif cell.instructor %}
                            <div style="font-size: 10px; color: #6b021f; margin-top: .25rem;">{{ cell.instructor }}</div>
                          {% endif %}

                          <!-- {# Room or other micro info #} -->
                          {% if cell.room %}
                            <div style="font-size:10px;color:#334155;margin-top:.25rem;">Room: {{ cell.room }}</div>
                          {% endif %}
                            </div>
                          </div>
                        </td>
                      {% else %}
                        <td style="color: #9ca3af; font-style: italic;">&nbsp;</td>
                      {% endif %}
                    {% endfor %}
                  {% endif %}
                </tr>
               {% endfor %}
              </tbody>
             </table>
            </div>
           </div>
          </div>

        </div>
      </div>
    </div>
  </div>
{% else %}
  <div class="container-fixed" id="content_container">
    <div class="card"><div class="card-body">
      <p class="text-center">No timetable data available.</p>
    </div></div>
  </div>
{% endif %}

    </main>
{% endblock %}
