{% extends "templates/layout.html" %}

{% block title %}
{{ _("Class Timetable") }}
{% endblock %}

{% block headnav_link %}
    {% include "templates/includes/headnav/edu_headnav2.html" %}
{% endblock %}

{% block content %}
<main class="grow content pt-5 bg-gray-100" id="content" role="content">
  <!-- begin: container -->
  <div class="container-fixed" id="content_container"></div>
  <!-- end: container -->
  <!-- begin: container -->
  <div class="container-fixed">
    <div class="flex flex-wrap items-center lg:items-end justify-between gap-5 pb-7.5">
      <div class="flex flex-col justify-center gap-2">
        <h1 class="text-xl font-semibold leading-none text-primary">Class Schedule</h1>
      </div>
       {% if "Academics User" in user_roles %}
       <div class="flex items-center gap-2.5">
        <a class="btn btn-sm btn-primary btn-light" href="/app/class-schedule/{% if schedule_name %}{{ schedule_name }}{% endif %}">
         Class Schedule Tool
        </a>
       </div>
       {% endif %}
    </div>
  </div>
  <!-- end: container -->

    {% include "templates/includes/section_nav.html" %}

  <!-- begin: container -->
{% if selected_section %} 
{% set section_doc = section_doc or {} %}
{% set timetable_slots = timetable_slots or [] %}
{% set days = days_order or [] %}
{% set timetable_map = timetable_map or {} %}

{% if timetable_slots and days %}
  <div class="container-fixed" id="content_container">
    <div class="grid gap-5 lg:gap-7.5">
      <div class="card">
        <div class="card-body lg:py-7.5">

          <p class="text-center">
            <b class="text-center text-info" style="font-size: 13pt">
              {{ section_doc.program_section if section_doc.program_section is defined else (selected_section if selected_section is string else '') }} Timetable
            </b>
          </p>
          <div class="grid">
           <div class="card min-w-full">
            <div class="card-table scrollable-x-auto">
             <table class="table align-middle text-center text-gray-700 font-medium text-xs">
              <thead>
               <tr>
                <th class="min-w-[125px]">
                 Start Time
                </th>
                <th class="min-w-[125px]">
                 End Time
                </th>
                {% for day in days %}
                <th class="min-w-[200px]">
                 {{ day }}
                </th>
                {% endfor %}
               </tr>
              </thead>
              <tbody>
               <!-- {# iterate through timetable slots in order; for each slot render a row #} -->
               {% for slot in timetable_slots %}
                <tr>
                  <td class="bg-success-light text-2xs" style="color: #043f80;">{{ frappe.utils.format_time(slot.start_time or slot.get("start_time"), "hh:mm a") }}</td>
                  <td class="bg-danger-light text-2xs" style="color: #043f80;">{{ frappe.utils.format_time(slot.end_time or slot.get("end_time"), "hh:mm a") }}</td>

                  <!-- {# if this slot is a break, render a single cell that spans all day columns #} -->
                  {% if slot.is_break %}
                    <td class="bg-info-light" style="text-align: center; font-style: italic; color: #374151;" colspan="{{ days|length }}">
                      <div>
                      <span style="font-weight:700;">
                        {{ slot.label or slot.period_label or "Break" }}: 
                      </span>
                      <span style="font-size:11px;color:#334155;">{{ frappe.utils.format_time(slot.start_time or slot.get("start_time"), "hh:mm a") }} - {{ frappe.utils.format_time(slot.end_time or slot.get("end_time"), "hh:mm a") }}</span>
                      {% if slot.duration %}
                        <span style="font-size:11px;color:#6b7280;"> ({{ slot.duration }} min)</span>
                      {% endif %}
                      </div>
                    </td>
                  {% else %}
                    <!-- {# Normal slot: render one cell per day using timetable_map[day][loop_index] #} -->
                    {% set idx = loop.index0 %}
                    {% for day in days %}
                      {% set day_row = timetable_map.get(day, []) %}
                      {% set cell = None %}
                      {% if day_row and day_row|length > idx %}
                        {% set cell = day_row[idx] %}
                      {% endif %}

                      {% if cell %}
                        {% set bg = cell.class_schedule_color if cell.class_schedule_color else '' %}
                        <td>
                          <div class="card" style="{% if bg %} background-color: {{ bg }};{% endif %}">
                            <div class="card-body">
                         <!-- <span class="badge badge-pill badge-outline badge-info"> -->
                          <!-- {# Course name (fall back to course field) #} -->
                          <div style="font-weight: 700; font-size: 11px;color: #374151;">
                            {% if cell.course_name %}{{ cell.course_name }}{% elif cell.course %}{{ cell.course }}{% else %}{{ cell.get('name') or 'Scheduled' }}{% endif %}
                          </div>
                         <!-- </span> -->

                          <!-- {# Instructor if available #} -->
                          {% if cell.instructor_name %}
                            <div style="font-size: 10px; color: #6b021f; margin-top: .25rem;">{{ cell.instructor_name }}</div>
                          {% elif cell.instructor %}
                            <div style="font-size: 10px; color: #6b021f; margin-top: .25rem;">{{ cell.instructor }}</div>
                          {% endif %}
                            <div style="font-size:9px;color:#334155;margin-top:.25rem;">{{ frappe.utils.format_time(slot.start_time or slot.get("start_time"), "hh:mm a") }} - {{ frappe.utils.format_time(slot.end_time or slot.get("end_time"), "hh:mm a") }}</div>

                          <!-- {# Room or other micro info #} -->
                          {% if cell.room %}
                            <div style="font-size:10px;color:#334155;margin-top:.25rem;">Room: {{ cell.room }}</div>
                          {% endif %}
                            </div>
                          </div>
                        </td>
                      {% else %}
                        <td>
                          <!-- <div class="card">
                            <div class="card-body"> -->
                              &nbsp;
                            <!-- </div>
                          </div> -->
                        </td>
                      {% endif %}
                    {% endfor %}
                  {% endif %}
                </tr>
               {% endfor %}
              </tbody>
              <tfoot>
               <tr>
                <th class="min-w-[125px]">
                 Start Time
                </th>
                <th class="min-w-[125px]">
                 End Time
                </th>
                {% for day in days %}
                <th class="min-w-[200px]">
                 {{ day }}
                </th>
                {% endfor %}
               </tr>
              </tfoot>
             </table>
            </div>
           </div>
          </div>
        </div>
      </div>
    </div>
  </div>
{% else %}
  <div class="container-fixed" id="content_container">
    <div class="card">
      <div class="card-body">
      <p class="text-center">No timetable data available.</p>
      </div>
    </div>
  </div>
{% endif %}
{% endif %} 
  <!-- end: container -->
</main>
{% endblock %}

{% block custom_js %}
{% endblock %}

{% block welcome_link %}
{% include "templates/includes/modal/schedule.html" %}
{% endblock %}
